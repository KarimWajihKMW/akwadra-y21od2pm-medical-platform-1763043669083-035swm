// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  TEACHER
  STUDENT
  PARENT
  ADMIN
}

enum AssignmentStatus {
  PENDING
  SUBMITTED
  GRADED
}

enum ExamStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  fullName      String
  role          Role      @default(STUDENT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  teacher       Teacher?
  student       Student?
  parent        Parent?

  @@index([email])
}

model Teacher {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialization String?
  bio           String?
  
  courses       Course[]
  lessons       Lesson[]
  assignments   Assignment[]
  exams         Exam[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Student {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  grade         String?
  parentId      String?
  parent        Parent?   @relation(fields: [parentId], references: [id])
  
  enrollments   Enrollment[]
  submissions   Submission[]
  examResults   ExamResult[]
  grades        Grade[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Parent {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone         String?
  
  children      Student[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Course {
  id            String    @id @default(cuid())
  title         String
  description   String?
  subject       String
  grade         String
  teacherId     String
  teacher       Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  lessons       Lesson[]
  enrollments   Enrollment[]
  assignments   Assignment[]
  exams         Exam[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([teacherId])
  @@index([subject])
  @@index([grade])
}

model Lesson {
  id            String    @id @default(cuid())
  title         String
  content       String?   @db.Text
  fileUrl       String?
  courseId      String
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacherId     String
  teacher       Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  order         Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([courseId])
  @@index([teacherId])
}

model Enrollment {
  id            String    @id @default(cuid())
  studentId     String
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId      String
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrolledAt    DateTime  @default(now())
  
  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

model Assignment {
  id            String    @id @default(cuid())
  title         String
  description   String?   @db.Text
  courseId      String
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacherId     String
  teacher       Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  dueDate       DateTime
  maxScore      Int       @default(100)
  
  submissions   Submission[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([courseId])
  @@index([teacherId])
}

model Submission {
  id            String    @id @default(cuid())
  assignmentId  String
  assignment    Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  content       String?   @db.Text
  fileUrl       String?
  status        AssignmentStatus @default(PENDING)
  score         Int?
  feedback      String?   @db.Text
  submittedAt   DateTime  @default(now())
  gradedAt      DateTime?
  
  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
}

model Exam {
  id            String    @id @default(cuid())
  title         String
  description   String?   @db.Text
  courseId      String
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacherId     String
  teacher       Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  scheduledAt   DateTime
  duration      Int       // in minutes
  maxScore      Int       @default(100)
  status        ExamStatus @default(SCHEDULED)
  
  results       ExamResult[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([courseId])
  @@index([teacherId])
}

model ExamResult {
  id            String    @id @default(cuid())
  examId        String
  exam          Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  score         Int
  answers       String?   @db.Text // JSON string
  submittedAt   DateTime  @default(now())
  
  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
}

model Grade {
  id            String    @id @default(cuid())
  studentId     String
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject       String
  grade         String
  score         Int
  term          String    // e.g., "Fall 2024", "Spring 2025"
  academicYear  String    // e.g., "2024-2025"
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([studentId])
  @@index([subject])
  @@index([academicYear])
}
